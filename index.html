<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <title>GhostApp - Xat històric</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #0b141a;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 10px;
    }

    .chat-wrapper {
      background: #111b21;
      width: 100%;
      max-width: 420px;
      height: 85vh;
      max-height: 780px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      background: #202c33;
      color: #e9edef;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #00a884;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #111b21;
      flex-shrink: 0;
    }

    .header-info {
      display: flex;
      flex-direction: column;
    }

    .contact-name {
      font-size: 14px;
      font-weight: 600;
    }

    .contact-status {
      font-size: 11px;
      color: #8696a0;
    }

    .chat-messages {
      flex: 1;
      background: radial-gradient(circle at top left, #202c33 0%, #111b21 45%, #0b141a 100%);
      padding: 10px 8px;
      overflow-y: auto;
    }

    .message-row {
      display: flex;
      margin-bottom: 6px;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.bot {
      justify-content: flex-start;
    }

    .message {
      max-width: 75%;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.3;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message.user .bubble {
      background: #005c4b;
      color: #e9edef;
      border-bottom-right-radius: 0;
    }

    .message.bot .bubble {
      background: #202c33;
      color: #e9edef;
      border-bottom-left-radius: 0;
    }

    .time {
      font-size: 10px;
      color: #8696a0;
      margin-left: 5px;
      align-self: flex-end;
    }

    .chat-input-area {
      background: #202c33;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chat-input-area input[type="text"] {
      flex: 1;
      background: #2a3942;
      border: none;
      border-radius: 20px;
      padding: 8px 12px;
      color: #e9edef;
      font-size: 13px;
      outline: none;
    }

    .chat-input-area button {
      background: #00a884;
      border: none;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
    }

    .chat-input-area button span {
      color: #111b21;
      font-size: 18px;
      font-weight: 600;
    }

    .helper {
      font-size: 10px;
      color: #8696a0;
      text-align: center;
      padding: 4px 8px;
      background: rgba(17, 27, 33, 0.9);
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }
    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
    }

    .typing-bubble {
      font-size: 11px;
      font-style: italic;
      opacity: 0.8;
    }
  </style>
</head>

<body>
  <div class="chat-wrapper">
    <div class="chat-header">
      <div class="avatar">G</div>
      <div class="header-info">
        <div class="contact-name">GhostApp</div>
        <div class="contact-status">en línia</div>
      </div>
    </div>

    <div class="helper">
      Aquesta és una conversa de GhostApp per poder parlar amb els esperits de personatges històrics del passat.
    </div>

    <div id="chatMessages" class="chat-messages"></div>

    <div class="chat-input-area">
      <input type="text" id="chatInput" placeholder="Escriu un missatge" autocomplete="off" />
      <button id="sendButton" aria-label="Enviar"><span>➤</span></button>
    </div>
  </div>

  <script>
    /************************************************************
     * ESTATS DEL GUIÓ A1–A8 + FINAL AUTOMÀTIC
     ************************************************************/

    let currentState = "A1";
    let userName = "";

    const botRules = [
      /* A2 — En què et puc ajudar? */
      {
        state: "A2",
        keywords: [
          "clau", "contrassenya", "contrasenya", "codi", "contraseña",
          "contrasseña", "números", "numeros", "combinació", "combinacion"
        ],
        reply:
          "Ahh sí, la contrasenya! Crec que jo tenia un codi per activar el sistema d’autoreparació de la màquina del temps! El problema és que ha passat molt de temps i no el recordo.\nAjuda’m a recuperar la memòria contestant unes preguntes sobre mi.\nQuin és el meu nom?",
        nextState: "A3"
      },

      /* A3 — Quin és el meu nom? */
      {
        state: "A3",
        keywords: [
          "gutenberg", "gutemberg", "guttemberg", "guttenberg"
        ],
        reply:
          "Ja ho recordo! Jo soc en Johannes Gutenberg! Moltes gràcies per ajudar-me, ja vaig recuperant la memòria. Però encara necessito més informació.\nRecordes on vaig néixer?",
        nextState: "A4"
      },

      /* A4 — On vaig néixer? */
      {
        state: "A4",
        keywords: [
          "alemanya", "alemania",
          "magúncia", "maguncia"
        ],
        reply:
          "Cert! Quins records! Vaig néixer a la ciutat de Magúncia a Alemanya.\nI què vaig inventar?",
        nextState: "A5"
      },

      /* A5 — Què vaig inventar? */
      {
        state: "A5",
        keywords: [
          "imprempta", "impremta", "imprenta"
        ],
        reply:
          "És veritat! Recordo que ningú confiava en el meu invent, però va acabar sent tot un èxit!\nPerò aleshores com s’escrivien els llibres abans de la invenció de la impremta?",
        nextState: "A6"
      },

      /* A6 — Com s’escrivien els llibres abans? */
      {
        state: "A6",
        keywords: [
          "mà", "manual", "manualment", "copiant", "copies", "còpies"
        ],
        reply:
          "És clar! Abans de la invenció de la impremta els llibres es copiaven a mà! Ja estic recuperant la memòria, tinc la contrasenya de la màquina del temps a la punta de la llengua.\nAjuda’m contestant un parell de preguntes més.\nDe quin material vaig fer les lletres de la meva impremta?",
        nextState: "A7"
      },

      /* A7 — Material de les lletres */
      {
        state: "A7",
        keywords: [
          "metall", "metal", "ferro", "coure", "acer",
          "hierro", "cobre", "acero",
          "metalico", "metalica",
          "metàlica", "metàliques", "metaliques", "metalicas"
        ],
        reply:
          "És veritat! El meu invent utilitzava tipus mòbils fets de metall i així eren més resistents i es podien fer tantes còpies com es volgués. El que no és tant resistent és la meva memòria... Però amb unes preguntes més la recuperaré segur!\nQuin és el primer llibre que vaig imprimir amb la impremta?",
        nextState: "A8"
      }
      /* A8 la tractem a part per enviar directament el final */
    ];

    // Paraules clau correcta per a A8
    const A8Keywords = [
      "biblia", "bíblia", "biblias", "biblies", "bíblies"
    ];

    const fallbackReplies = {
      A2: "Ho sento, no t’he entès. En què puc ajudar-te?",
      A3: "Ho sento, no t’he entès. Quin és el meu nom?",
      A4: "Ho sento, no t’he entès. On vaig néixer?",
      A5: "Ho sento, no t’he entès. Què vaig inventar?",
      A6: "Ho sento, no t’he entès. Com s’escrivien els llibres abans de la impremta?",
      A7: "Ho sento, no t’he entès. De quin material vaig fer les lletres de la meva impremta?",
      A8: "Ho sento, no t’he entès. Quin és el primer llibre que vaig imprimir amb la impremta?"
    };

    /************************************************************
     * TIPING + MISSATGES AMB RETARD
     ************************************************************/

    const chatMessagesEl = document.getElementById("chatMessages");
    const chatInputEl = document.getElementById("chatInput");
    const sendButtonEl = document.getElementById("sendButton");

    function showTyping() {
      if (document.getElementById("typingIndicator")) return;
      const row = document.createElement("div");
      row.classList.add("message-row", "bot");
      row.id = "typingIndicator";

      const msg = document.createElement("div");
      msg.classList.add("message", "bot");

      const bubble = document.createElement("div");
      bubble.classList.add("bubble", "typing-bubble");
      bubble.textContent = "Escrivint...";

      msg.appendChild(bubble);
      row.appendChild(msg);
      chatMessagesEl.appendChild(row);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function hideTyping() {
      const typingEl = document.getElementById("typingIndicator");
      if (typingEl) typingEl.remove();
    }

    function delayedBotMessage(text) {
      showTyping();
      const delay = 1200 + Math.random() * 800;
      setTimeout(() => {
        hideTyping();
        addBotMessage(text);
      }, delay);
    }

    /************************************************************
     * INICIALITZACIÓ
     ************************************************************/

    window.addEventListener("load", () => {
      delayedBotMessage("Hola! Com et dius?");
    });

    sendButtonEl.addEventListener("click", () => handleSend());
    chatInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        handleSend();
      }
    });

    function handleSend() {
      const text = chatInputEl.value.trim();
      if (!text || currentState === "FI") return;
      addUserMessage(text);
      chatInputEl.value = "";
      processBotReply(text);
    }

    /************************************************************
     * AFEGIR MISSATGES AL XAT
     ************************************************************/

    function addUserMessage(text) {
      addMessage("user", text);
    }

    function addBotMessage(text) {
      addMessage("bot", text);
    }

    function addMessage(sender, text) {
      const row = document.createElement("div");
      row.classList.add("message-row", sender);

      const msg = document.createElement("div");
      msg.classList.add("message", sender);

      const bubble = document.createElement("div");
      bubble.classList.add("bubble");
      bubble.textContent = text;

      const timeEl = document.createElement("span");
      timeEl.classList.add("time");
      timeEl.textContent = new Date().toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });

      msg.appendChild(bubble);
      msg.appendChild(timeEl);
      row.appendChild(msg);
      chatMessagesEl.appendChild(row);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    /************************************************************
     * LÒGICA DE RESPOSTA DEL BOT
     ************************************************************/

    function processBotReply(text) {
      const normalized = text.toLowerCase();

      // A1 — Nom (accepta qualsevol cosa)
      if (currentState === "A1") {
        userName = text.trim();
        delayedBotMessage(`Encantat de conèixer-te ${userName}. En què et puc ajudar?`);
        currentState = "A2";
        return;
      }

      // A8 — tractament especial: si és correcta, envia directament el missatge final (A9)
      if (currentState === "A8") {
        const isCorrect = A8Keywords.some(k => normalized.includes(k));
        if (isCorrect) {
          const finalMsg =
            "Genial. Moltíssimes gràcies! Ja he recuperat la memòria!\n" +
            "El codi per activar el sistema d’autoreparació de la màquina del temps és \"curasana\".\n" +
            "Espero que et sigui útil i puguis reparar-la.\n" +
            `Encantat d’haver-te conegut ${userName}. Fins a la propera!`;
          delayedBotMessage(finalMsg);
          currentState = "FI";
        } else {
          delayedBotMessage(fallbackReplies["A8"]);
        }
        return;
      }

      // Per a A2–A7: busquem regla B1
      const candidates = botRules.filter(r => r.state === currentState);
      const matchedRule = candidates.find(rule =>
        rule.keywords.some(k => normalized.includes(k))
      );

      if (matchedRule) {
        delayedBotMessage(matchedRule.reply);
        currentState = matchedRule.nextState;
        return;
      }

      // B2 — resposta incorrecta: Ax.2
      if (fallbackReplies[currentState]) {
        delayedBotMessage(fallbackReplies[currentState]);
        return;
      }

      // Per si de cas queda algun cas no contemplat
      delayedBotMessage("No acabo d’entendre el que m’has escrit... Prova-ho d’una altra manera.");
    }
  </script>
</body>
</html>

